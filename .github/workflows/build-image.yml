name: Build Custom RHEL AI Image
on:
  push:
    branches: [ "main" ]  # Build when you change your config
  schedule:
    - cron: '0 0 * * 0'    # Automatically build every Sunday (to catch RHEL updates)
  workflow_dispatch:      # Allows you to click a button to build manually

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
          
      - name: Maximize Build Space
        run: |
          # Remove heavy pre-installed software to make room for RHEL AI
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          
          # Clean up Docker images that GitHub pre-loads
          docker image prune -af
          
          echo "Disk space after cleanup:"
          df -h /

      - name: Log in to Red Hat Registry
        run: podman login -u ${{ secrets.REDHAT_USERNAME }} -p ${{ secrets.REDHAT_PASSWORD }} registry.redhat.io

      - name: Log in to Destination Registry
        run: podman login -u ${{ secrets.REGISTRY_USERNAME }} -p ${{ secrets.REGISTRY_PASSWORD }} quay.io
      - name: Build Image
        run: |
          podman build \
            --squash \
            --build-arg RH_ORG=${{ secrets.RH_ORGANIZATION_ID }} \
            --build-arg RH_KEY=${{ secrets.RH_ACTIVATION_KEY }} \
            -t ${{ secrets.REGISTRY_DESTINATION }}:latest .

      - name: Push Image
        run: podman push ${{ secrets.REGISTRY_DESTINATION }}:latest
