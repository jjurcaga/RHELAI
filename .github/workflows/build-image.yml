name: Build Custom RHEL AI Image
on:
  push:
    branches: [ "main" ]  # Build when you change your config
  schedule:
    - cron: '0 0 * * 0'    # Automatically build every Sunday (to catch RHEL updates)
  workflow_dispatch:      # Allows you to click a button to build manually

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to Red Hat Registry
        run: podman login -u ${{ secrets.REDHAT_USERNAME }} -p ${{ secrets.REDHAT_PASSWORD }} registry.redhat.io

      - name: Log in to Destination Registry
        run: podman login -u ${{ secrets.REGISTRY_USERNAME }} -p ${{ secrets.REGISTRY_PASSWORD }} quay.io
      - name: Build Image
        env:
          # This tells Podman where the user session bus is located
          XDG_RUNTIME_DIR: /run/user/${{ steps.get_uid.outputs.uid }}
        run: |
          podman build --squash -t "$IMAGE_DEST":latest .
        run: |
          podman build \
            --squash \
            --build-arg RH_ORG=${{ secrets.RH_ORGANIZATION_ID }} \
            --build-arg RH_KEY=${{ secrets.RH_ACTIVATION_KEY }} \
            -t ${{ secrets.REGISTRY_DESTINATION }}:latest .

      - name: Push Image
        run: podman push ${{ secrets.REGISTRY_DESTINATION }}:latest
